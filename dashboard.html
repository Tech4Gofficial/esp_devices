<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard-V1.0</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { --bg:#eef2f7; --card:#fff; --primary:#4f46e5; --ok:#10b981; --danger:#ef4444; }
        body { margin:0; padding:10px; font-family:'Segoe UI', sans-serif; background:var(--bg); padding-bottom: 80px; }
        .nav-header { background:#1e293b; color:#fff; padding:12px; border-radius:12px; display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
        .top-bar { text-align:center; padding:10px; font-weight:bold; color:#1e293b; font-size:18px; }
        
        .card { background:var(--card); border-radius:12px; margin-bottom:10px; border:1px solid #ddd; overflow:hidden; transition: 0.3s; }
        .card.active { border-color:var(--primary); box-shadow:0 4px 12px rgba(79,70,229,.15); }
        .card-header { padding:15px; cursor:pointer; display:flex; justify-content:space-between; background:#f8fafc; font-weight:bold; align-items:center; }
        .card-body { padding:15px; border-top:1px solid #eee; }
        
        .master-row { display:flex; justify-content:space-between; align-items:center; background:#f1f5f9; padding:10px; border-radius:10px; margin-bottom:15px; }
        
        .switch { position:relative; width:40px; height:20px; display:inline-block; cursor: pointer; }
        .switch input { opacity:0; width:0; height:0;}
        .slider { position:absolute; inset:0; background:#cbd5e1; border-radius:34px; transition:.3s; cursor:pointer; }
        .slider:before { content:""; position:absolute; height:14px; width:14px; left:3px; bottom:3px; background:#fff; border-radius:50%; transition:.3s; }
        input:checked + .slider { background:var(--ok); }
        input:checked + .slider:before { transform:translateX(20px); }

        .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:1000; padding:10px; }
        .modal-content { background:white; padding:15px; border-radius:15px; width:100%; max-width:500px; max-height: 85vh; overflow-y: auto; }
        .page-view { display:none; }
        .page-view.active { display:block; }
        
        .btn-box { padding:8px; border:1px solid #ddd; border-radius:8px; cursor:pointer; font-size:11px; background:#f9fafb; margin:2px; display:inline-block; min-width:40px; text-align:center; }
        .btn-box.active { background:var(--primary); color:white; border-color:var(--primary); }
        
        .act-btn { flex:1; padding:10px; border:1px solid #ddd; text-align:center; cursor:pointer; font-size:12px; font-weight:bold; background:#f9fafb; border-radius:8px; }
        .act-btn.on-active { background:var(--ok); color:white; border-color:var(--ok); }
        .act-btn.off-active { background:var(--danger); color:white; border-color:var(--danger); }

        .table-container { width:100%; overflow-x:auto; margin-top:10px; }
        table { width:100%; border-collapse:collapse; font-size:11px; white-space: nowrap; }
        th, td { border:1px solid #eee; padding:10px 5px; text-align:center; vertical-align: middle; }
        
        .btn-save { width:100%; background:var(--ok); color:white; border:none; padding:14px; border-radius:10px; font-weight:bold; cursor:pointer; margin-top:15px; }
        .btn-ctrl { background:#64748b; color:white; border:none; padding:4px 10px; border-radius:5px; font-size:10px; cursor:pointer; margin-left:8px; }
        .rename-btn { background:none; border:none; color:var(--primary); cursor:pointer; font-size:12px; margin-left:5px; opacity: 0.6; }

        /* Floating Add Button */
        .add-btn-fixed { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); border: none; cursor: pointer; z-index: 99; }
        .device-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="nav-header">
    <div id="user-display" style="color:#fbbf24; font-weight:bold;">ID: patelharesh.dsr</div>
    <div style="font-weight:900;">SMART HOME</div>
    <button onclick="location.reload()" style="background:var(--danger); color:white; border:none; padding:5px 10px; border-radius:6px; font-size:10px; cursor:pointer;">REFRESH</button>
</div>

<div class="top-bar" id="clock">00:00:00</div>
<div id="device-container" style="text-align: center; padding: 20px;">àª¡àª¿àªµàª¾àª‡àª¸ àª¶à«‹àª§à«€ àª°àª¹à«àª¯àª¾ àª›à«€àª...</div>

<button class="add-btn-fixed" onclick="openAddModal()">+</button>

<div id="add-modal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0;">àª¨àªµà«àª‚ àª¡àª¿àªµàª¾àª‡àª¸ àª¶à«‹àª§à«‹</h3>
        <div id="search-list" style="max-height: 250px; overflow-y: auto; margin-bottom: 15px;"></div>
        <div id="name-box" style="display:none;">
            <p id="selected-id-display" style="font-size:12px; color:#64748b; font-weight:bold;"></p>
            <input type="text" id="new-dev-name" placeholder="àª¡àª¿àªµàª¾àª‡àª¸àª¨à«àª‚ àª¨àª¾àª® (e.g. Kitchen)" style="width:100%; padding:12px; margin:10px 0; border:1px solid #ddd; border-radius:8px; box-sizing:border-box;">
            <button onclick="saveNewDevice()" class="btn-save">àª¸à«‡àªµ àª•àª°à«‹</button>
        </div>
        <button onclick="closeAddModal()" style="width:100%; margin-top:10px; padding:12px; border:none; background:#64748b; color:white; border-radius:10px;">àª¬àª‚àª§ àª•àª°à«‹</button>
    </div>
</div>

<div id="sched-modal" class="modal">
    <div class="modal-content">
        <div id="page-list" class="page-view active">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <h3 style="margin:0;">Timers List</h3>
                    <p id="current-timer-device" style="margin:0; font-size:12px; color:var(--primary); font-weight:bold;"></p>
                </div>
                <button onclick="switchPage('form')" style="background:var(--ok); color:white; border:none; width:35px; height:35px; border-radius:50%; font-size:22px; cursor:pointer;">+</button>
            </div>
            <div class="table-container">
                <table>
                    <thead><tr><th>SW</th><th>Time</th><th>Day</th><th>Act</th><th>On/Off</th><th>X</th></tr></thead>
                    <tbody id="timer-list-body"></tbody>
                </table>
            </div>
            <button onclick="closeModal()" style="width:100%; margin-top:15px; padding:12px; border-radius:10px; border:none; background:#64748b; color:white; font-weight:bold; cursor:pointer;">CLOSE</button>
        </div>

        <div id="page-form" class="page-view">
            <h3>Set Timer</h3>
            <p style="font-size:11px; font-weight:bold; margin:5px 0;">Switches: <button class="btn-ctrl" onclick="toggleAll('sw-opt')">All</button></p>
            <div id="sw-selectors"></div>
            <p style="font-size:11px; font-weight:bold; margin:10px 0 5px;">Days: <button class="btn-ctrl" onclick="toggleAll('day-opt')">All</button></p>
            <div id="day-selectors">
                <div class="btn-box day-opt" data-val="Mon">M</div><div class="btn-box day-opt" data-val="Tue">T</div><div class="btn-box day-opt" data-val="Wed">W</div><div class="btn-box day-opt" data-val="Thu">T</div><div class="btn-box day-opt" data-val="Fri">F</div><div class="btn-box day-opt" data-val="Sat">S</div><div class="btn-box day-opt" data-val="Sun">S</div>
            </div>
            <div style="display:flex; gap:10px; margin-top:15px; align-items:center;">
                <input type="time" id="s-time" style="flex:1.5; padding:10px; border:1px solid #ddd; border-radius:8px;">
                <div style="flex:2; display:flex; gap:5px;">
                    <div id="act-on" class="act-btn" onclick="setAction('ON')">ON</div>
                    <div id="act-off" class="act-btn" onclick="setAction('OFF')">OFF</div>
                </div>
            </div>
            <button onclick="saveSchedule()" class="btn-save">SAVE TIMER</button>
            <button onclick="resetForm(); switchPage('list');" style="width:100%; margin-top:10px; background:none; border:none; color:var(--primary); font-weight:bold; cursor:pointer;">Back to List</button>
        </div>
    </div>
</div>

<script>
const firebaseConfig = { apiKey: "AIzaSyBSHuKZ6ttE-08cwZcNMeclyqGWAxLTSts", databaseURL: "https://esp-devices-d862a-default-rtdb.firebaseio.com" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const USER_EMAIL = "patelharesh.dsr@gmail.com", MASTER_UID = "MASTER_USER"; 

let openDevId = null, activeSchedId = null, currentData = null, selectedAction = 'ON', selectedNewDevId = null;

function init() { 
    const displayName = USER_EMAIL.split('@')[0];
    document.getElementById('user-display').innerText = "ID: " + displayName;
    db.ref().on('value', snap => { 
        currentData = snap.val(); 
        renderUI(); 
        if(activeSchedId) renderFormSwitches(); 
    }); 
    setAction('ON'); 
    setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString('en-GB'); }, 1000);
}

function getSwName(devId, relayKey) {
    const d = currentData.users_devices_status[devId];
    if (d && d.names && d.names[relayKey]) return d.names[relayKey];
    return "Switch " + relayKey.replace('relay', '');
}

function renameDevice(devId, oldName) {
    const newName = prompt("àª¡àª¿àªµàª¾àª‡àª¸àª¨à«àª‚ àª¨àªµà«àª‚ àª¨àª¾àª® àª²àª–à«‹:", oldName);
    if (newName && newName.trim() !== "") {
        db.ref(`users/${MASTER_UID}/devices/${devId}`).update({ name: newName.trim() });
    }
}

function renameSwitch(devId, relay, oldName) {
    const newName = prompt("àª¸à«àªµàª¿àªšàª¨à«àª‚ àª¨àªµà«àª‚ àª¨àª¾àª® àª²àª–à«‹:", oldName);
    if (newName && newName.trim() !== "") {
        db.ref(`users_devices_status/${devId}/names`).update({ [relay]: newName.trim() });
    }
}

function renderUI() {
    if (!currentData) return;
    const box = document.getElementById('device-container');
    const statusData = currentData.users_devices_status || {};
    const userDevices = (currentData.users && currentData.users[MASTER_UID]) ? currentData.users[MASTER_UID].devices : {};

    box.innerHTML = "";
    Object.keys(userDevices).forEach(id => {
        const d = statusData[id] || {};
        const deviceDisplayName = userDevices[id].name || id;
        
        const isAllOn = d.relay0 && d.relay1 && d.relay2 && d.relay3;
        const card = document.createElement('div');
        card.className = `card ${openDevId === id ? 'active' : ''}`;
        card.innerHTML = `
            <div class="card-header">
                <div onclick="toggleCard('${id}')" style="flex:1;">
                    <span>${deviceDisplayName}</span>
                    <span style="margin-left:5px;">${openDevId === id ? 'â–´' : 'â–¾'}</span>
                </div>
                <button class="rename-btn" onclick="renameDevice('${id}', '${deviceDisplayName}')">âœ</button>
            </div>
            <div class="card-body" style="display:${openDevId === id ? 'block' : 'none'}">
                <div class="master-row"><b>Master Control</b><label class="switch"><input type="checkbox" ${isAllOn?'checked':''} onchange="fastToggleMaster('${id}', this.checked)"><span class="slider"></span></label>
                <button class="btn-ctrl" style="background:var(--primary)" onclick="openModal('${id}', '${deviceDisplayName}')">ğŸ“… Timers</button></div>
                ${[0,1,2,3].map(i => {
                    const rKey = 'relay'+i;
                    const name = getSwName(id, rKey);
                    return `
                    <div style="display:flex; justify-content:space-between; margin-bottom:12px; align-items:center;">
                        <span><b>${name}</b> <button class="rename-btn" onclick="renameSwitch('${id}', '${rKey}', '${name}')">âœ</button></span>
                        <label class="switch"><input type="checkbox" ${d[rKey]?'checked':''} onchange="fastToggleRelay('${id}', '${rKey}', this.checked)"><span class="slider"></span></label>
                    </div>`;
                }).join('')}
            </div>`;
        box.appendChild(card);
    });
}

function toggleCard(id) { openDevId = (openDevId === id) ? null : id; renderUI(); }
function fastToggleRelay(id, relay, newState) { db.ref(`users_devices_status/${id}`).update({ [relay]: newState }); }
function fastToggleMaster(id, newState) { db.ref(`users_devices_status/${id}`).update({ relay0: newState, relay1: newState, relay2: newState, relay3: newState }); }

function openModal(id, name) { 
    activeSchedId = id; 
    document.getElementById('current-timer-device').innerText = "Device: " + name;
    renderFormSwitches(); 
    switchPage('list'); 
    document.getElementById('sched-modal').style.display='flex'; 
    loadTimerList(); 
}
function closeModal() { document.getElementById('sched-modal').style.display='none'; }
function switchPage(p) { document.querySelectorAll('.page-view').forEach(v => v.classList.remove('active')); document.getElementById('page-'+p).classList.add('active'); }

function toggleAll(cls) {
    const items = document.querySelectorAll('.' + cls);
    const allActive = Array.from(items).every(i => i.classList.contains('active'));
    items.forEach(i => allActive ? i.classList.remove('active') : i.classList.add('active'));
}

function setAction(act) {
    selectedAction = act;
    document.getElementById('act-on').classList.toggle('on-active', act === 'ON');
    document.getElementById('act-off').classList.toggle('off-active', act === 'OFF');
}

function resetForm() { document.querySelectorAll('.btn-box').forEach(b => b.classList.remove('active')); document.getElementById('s-time').value = ""; setAction('ON'); }

document.addEventListener('click', e => { if(e.target.classList.contains('sw-opt') || e.target.classList.contains('day-opt')) e.target.classList.toggle('active'); });

function saveSchedule() {
    const time = document.getElementById('s-time').value;
    const sws = Array.from(document.querySelectorAll('.sw-opt.active')).map(b => b.dataset.val);
    const selectedDaysArr = Array.from(document.querySelectorAll('.day-opt.active')).map(b => b.dataset.val);
    const dys = (selectedDaysArr.length === 7) ? "All Days" : (selectedDaysArr.join(",") || "All Days");
    if(!time || !sws.length) return alert("àªµàª¿àª—àª¤à«‹ àª…àª§à«‚àª°à«€ àª›à«‡!");
    sws.forEach(sw => { db.ref(`users_devices_status/${activeSchedId}/timers/${sw}`).push({ time, action: selectedAction, days: dys, enabled: true }); });
    resetForm(); switchPage('list');
}

function loadTimerList() {
    const body = document.getElementById('timer-list-body');
    db.ref(`users_devices_status/${activeSchedId}/timers`).on('value', snap => {
        body.innerHTML = "";
        snap.forEach(swNode => {
            swNode.forEach(tNode => {
                const t = tNode.val(), tid = tNode.key, sw = swNode.key;
                const swDisplayName = getSwName(activeSchedId, sw);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td onclick="editTimer('${sw}','${t.time}','${t.days}','${t.action}')">${swDisplayName}</td>
                    <td onclick="editTimer('${sw}','${t.time}','${t.days}','${t.action}')">${t.time}</td>
                    <td onclick="editTimer('${sw}','${t.time}','${t.days}','${t.action}')">${t.days}</td>
                    <td onclick="editTimer('${sw}','${t.time}','${t.days}','${t.action}')"><b style="color:${t.action==='ON'?'#10b981':'#ef4444'}">${t.action}</b></td>
                    <td><label class="switch"><input type="checkbox" ${t.enabled?'checked':''} onchange="toggleEnabled('${sw}','${tid}',this.checked)"><span class="slider"></span></label></td>
                    <td onclick="deleteT('${sw}','${tid}')" style="color:red; font-weight:bold; cursor:pointer;">X</td>`;
                body.appendChild(row);
            });
        });
    });
}

function editTimer(sw, time, days, action) {
    switchPage('form');
    document.getElementById('s-time').value = time;
    setAction(action);
    document.querySelectorAll('.sw-opt').forEach(b => b.classList.toggle('active', b.dataset.val === sw));
    document.querySelectorAll('.day-opt').forEach(b => b.classList.toggle('active', (days === "All Days" || days.includes(b.dataset.val))));
}

function toggleEnabled(sw, tid, status) { db.ref(`users_devices_status/${activeSchedId}/timers/${sw}/${tid}`).update({enabled: status}); }
function deleteT(sk, tk) { if(confirm("Delete this timer?")) db.ref(`users_devices_status/${activeSchedId}/timers/${sk}/${tk}`).remove(); }

function renderFormSwitches() {
    const container = document.getElementById('sw-selectors');
    if(!activeSchedId) return;
    container.innerHTML = [0,1,2,3].map(i => {
        const rKey = 'relay'+i;
        return `<div class="btn-box sw-opt" data-val="${rKey}">${getSwName(activeSchedId, rKey)}</div>`;
    }).join('');
}

// --- ADD DEVICE LOGIC ---
function openAddModal() {
    document.getElementById('add-modal').style.display='flex';
    const list = document.getElementById('search-list');
    list.innerHTML = '<div style="text-align:center;"><div class="loader"></div><br>àª¸à«àª•à«‡àª¨ àª¥àªˆ àª°àª¹à«àª¯à«àª‚ àª›à«‡...</div>';
    
    db.ref('users_devices_status').once('value', snap => {
        list.innerHTML = "";
        const allStatus = snap.val() || {};
        const myDevices = (currentData.users && currentData.users[MASTER_UID]) ? currentData.users[MASTER_UID].devices : {};
        
        Object.keys(allStatus).forEach(id => {
            if(!myDevices || !myDevices[id]) {
                const d = document.createElement('div');
                d.className = 'device-item';
                d.innerHTML = `<b>Device ID:</b> ${id} <span style="float:right; color:var(--primary);">+ Add</span>`;
                d.onclick = () => {
                    selectedNewDevId = id;
                    document.getElementById('selected-id-display').innerText = "ID: " + id;
                    document.getElementById('name-box').style.display = 'block';
                    list.style.display = 'none';
                };
                list.appendChild(d);
            }
        });
        if(!list.innerHTML) list.innerHTML = "<p style='text-align:center; padding:20px;'>àª•à«‹àªˆ àª¨àªµàª¾ àª¡àª¿àªµàª¾àª‡àª¸ àª®àª³à«àª¯àª¾ àª¨àª¥à«€.</p>";
    });
}

function saveNewDevice() {
    const name = document.getElementById('new-dev-name').value;
    if(!name) return alert("àª¨àª¾àª® àª²àª–à«‹!");
    db.ref(`users/${MASTER_UID}/devices/${selectedNewDevId}`).set({ name: name.trim() }).then(() => {
        alert("àª¡àª¿àªµàª¾àª‡àª¸ àª‰àª®à«‡àª°àª¾àªˆ àª—àª¯à«àª‚!");
        location.reload();
    });
}

function closeAddModal() {
    document.getElementById('add-modal').style.display='none';
    document.getElementById('name-box').style.display = 'none';
    document.getElementById('search-list').style.display = 'block';
}

init();
</script>
</body>
</html>
